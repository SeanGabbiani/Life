<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0d12" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <title>Game of Life ‚Äî iPad</title>
  <style>
    :root{
      --bg:#0b0d12; --fg:#eaecf1; --muted:#9aa3b2;
      --accent:#7c5cff; --accent2:#2ee6a6;
      --glass:rgba(255,255,255,.06); --glass-strong:rgba(255,255,255,.12);
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; overscroll-behavior:none;}
    #app{position:fixed; inset:0}
    canvas{display:block; width:100%; height:100%; touch-action:none; background:#05070b}

    /* bottom toolbar (icon-only, wraps safely) */
    .bar{
      position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom,0px)+12px); transform:translateX(-50%);
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      background:var(--glass); backdrop-filter:blur(16px) saturate(120%);
      border:1px solid var(--glass-strong); border-radius:var(--radius);
      padding:10px 12px; box-shadow:var(--shadow); z-index:9999; max-width:min(980px,92vw);
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:44px; height:44px; font-size:22px; border-radius:12px;
      background:rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.15);
      white-space:nowrap; flex:0 0 auto;
    }
    .btn:active{transform:translateY(1px)}
    .btn.toggle[aria-pressed="true"]{background:var(--accent); color:#fff}
    .btn.secondary{background:rgba(255,255,255,.04); color:var(--muted)}

    .seg{display:flex; gap:6px; padding:4px; border-radius:12px;
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12)}
    .seg .btn{width:38px; height:38px; font-size:18px}

    .slider{ -webkit-appearance:none; appearance:none; height:8px; border-radius:999px;
      background:rgba(255,255,255,.12); outline:none; width:160px; flex:0 0 auto;}
    .slider::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:22px; height:22px; border-radius:50%;
      background:var(--accent2); border:2px solid rgba(0,0,0,.25); box-shadow:0 2px 6px rgba(0,0,0,.35); }
    .badge{ font-variant-numeric: tabular-nums; color:var(--muted); font-size:12px; margin-left:6px}

    /* left stamps toolbar */
    #stamps{
      position:fixed; top:50%; left:12px; transform:translateY(-50%);
      display:flex; flex-direction:column; gap:8px; z-index:9999;
      background:var(--glass); border:1px solid var(--glass-strong);
      border-radius:16px; padding:8px; box-shadow:var(--shadow);
    }
    #stamps .stamp{
      width:38px; height:38px; font-size:18px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:10px; border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.08); color:#fff;
    }
    #stamps .stamp[aria-pressed="true"]{ background:var(--accent); color:#fff }
    @media (max-width:820px){ #stamps{ left:8px } }

    .hint{position:fixed; top:14px; left:50%; transform:translateX(-50%); color:var(--muted); font-size:12px; opacity:.75}
  </style>
</head>
<body>
  <div id="app">
    <canvas id="life"></canvas>
  </div>

  <!-- left ‚Äústamp‚Äù toolbar -->
  <div id="stamps" aria-label="Pattern stamps">
    <button class="stamp" data-pattern="glider"  title="Glider">ü°≤</button>
    <button class="stamp" data-pattern="lwss"    title="Lightweight spaceship">üöÄ</button>
    <button class="stamp" data-pattern="blinker" title="Blinker">‚îÇ</button>
    <button class="stamp" data-pattern="pulsar"  title="Pulsar">‚ú∏</button>
    <button class="stamp" data-pattern="clear"   title="Stamp off">‚èπ</button>
  </div>

  <!-- bottom icon-only controls -->
  <div class="bar" role="toolbar" aria-label="Controls">
    <button id="run"   class="btn toggle"   aria-pressed="false" title="Run / Pause">‚ñ∂</button>
    <button id="step"  class="btn secondary" title="Step">‚è©</button>

    <div class="seg" aria-label="Draw tools">
      <button id="paint" class="btn toggle" aria-pressed="false" title="Live Paint">üé®</button>
      <button id="erase" class="btn toggle" aria-pressed="false" title="Erase">‚ê°</button>
    </div>

    <div class="seg" aria-label="Presets">
      <button id="random" class="btn" title="Randomize">üé≤</button>
      <button id="clear"  class="btn" title="Clear">üßπ</button>
    </div>

    <div class="seg" aria-label="Speed">
      <input id="speed" class="slider" type="range" min="2" max="60" value="30" />
      <span class="badge" id="fpsLabel">30 fps</span>
    </div>
  </div>

  <div class="hint">Tip: two-finger drag to pan, pinch to zoom. Tap to toggle cells. Select a stamp on the left to ‚Äúplace‚Äù patterns.</div>

  <script>
    // ---------- Canvas & grid ----------
    const canvas = document.getElementById('life');
    const ctx = canvas.getContext('2d', { alpha:false });
    const DPR = Math.max(1, window.devicePixelRatio || 1);

    let size = 120;       // grid is size x size
    let cellSize = 7;     // px per cell (logical before DPR)
    canvas.width  = size * cellSize * DPR;
    canvas.height = size * cellSize * DPR;
    canvas.style.width  = size * cellSize + 'px';
    canvas.style.height = size * cellSize + 'px';

    let grid = new Uint8Array(size * size);

    function draw(){
      ctx.fillStyle = '#05070b';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // subtle grid lines
      if (cellSize * DPR >= 8){
        ctx.strokeStyle = 'rgba(255,255,255,0.05)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let x=0;x<=size;x++){
          const px = Math.floor(x*cellSize*DPR)+.5;
          ctx.moveTo(px,0); ctx.lineTo(px,canvas.height);
        }
        for(let y=0;y<=size;y++){
          const py = Math.floor(y*cellSize*DPR)+.5;
          ctx.moveTo(0,py); ctx.lineTo(canvas.width,py);
        }
        ctx.stroke();
      }

      // alive cells
      ctx.fillStyle = '#cfd6ff';
      for (let i=0;i<grid.length;i++){
        if (!grid[i]) continue;
        const x = (i % size), y = (i / size | 0);
        const px = Math.floor(x*cellSize*DPR);
        const py = Math.floor(y*cellSize*DPR);
        const s  = Math.floor(cellSize*DPR)-1;
        ctx.fillRect(px+1, py+1, s-1, s-1);
      }
    }

    function idx(x,y){ return y*size + x }

    function randomize(d=0.18){
      for (let i=0;i<grid.length;i++) grid[i] = Math.random()<d ? 1:0;
      draw();
    }
    function clearAll(){ grid.fill(0); draw(); }

    function step(){
      const next = grid.slice();
      for (let i=0;i<grid.length;i++){
        const x = i % size, y = (i/size|0);
        let n = 0;
        for (let dy=-1;dy<=1;dy++)
          for (let dx=-1;dx<=1;dx++){
            if (dx===0 && dy===0) continue;
            const nx = x+dx, ny = y+dy;
            if (nx>=0 && nx<size && ny>=0 && ny<size) n += grid[idx(nx,ny)];
          }
        next[i] = (n===3 || (grid[i] && n===2)) ? 1 : 0;
      }
      grid = next; draw();
    }

    // ---------- Stamps ----------
    const patterns = {
      glider:  [[1,0],[2,1],[0,2],[1,2],[2,2]],
      lwss:    [[1,0],[2,0],[3,0],[4,0],[0,1],[4,1],[4,2],[0,3],[3,3]],
      blinker: [[-1,0],[0,0],[1,0]],
      pulsar:  [[-6,-4],[-5,-4],[-4,-4],[-2,-4],[-1,-4],[0,-4],
                [-6, 4],[-5, 4],[-4, 4],[-2, 4],[-1, 4],[0, 4],
                [-4,-6],[-4,-5],[-4,-2],[-4,-1],[-4, 0],[-4, 1],
                [ 4,-6],[ 4,-5],[ 4,-2],[ 4,-1],[ 4, 0],[ 4, 1]],
    };

    let currentStamp = null;
    function setStamp(name){
      const btns = document.querySelectorAll('#stamps .stamp');
      btns.forEach(b=>b.setAttribute('aria-pressed','false'));
      if (!name || name==='clear'){ currentStamp = null; return; }
      currentStamp = patterns[name];
      const b = [...btns].find(b=>b.dataset.pattern===name);
      if (b) b.setAttribute('aria-pressed','true');
    }
    document.querySelectorAll('#stamps .stamp').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const name = btn.dataset.pattern;
        const isOn = btn.getAttribute('aria-pressed')==='true';
        setStamp(isOn ? 'clear' : name);
      });
    });

    function stampAt(x,y){
      if (!currentStamp) return false;
      currentStamp.forEach(([dx,dy])=>{
        const nx=x+dx, ny=y+dy;
        if (nx>=0 && nx<size && ny>=0 && ny<size) grid[idx(nx,ny)] = 1;
      });
      return true;
    }

    // ---------- Interaction ----------
    let running=false, painting=false, erasing=false;
    let fps = 30, loopId=null;
    const fpsLabel = document.getElementById('fpsLabel');

    function loop(){
      step();
      loopId = setTimeout(()=>requestAnimationFrame(loop), 1000/fps);
    }

    function toggleRun(){
      running = !running;
      document.getElementById('run').setAttribute('aria-pressed', running?'true':'false');
      if (running){ loop(); } else { clearTimeout(loopId); loopId=null; }
    }

    document.getElementById('run').addEventListener('click', toggleRun);
    document.getElementById('step').addEventListener('click', ()=>{ if(!running){ step(); } });

    document.getElementById('paint').addEventListener('click', ()=>{
      painting = !painting;
      document.getElementById('paint').setAttribute('aria-pressed', painting?'true':'false');
      if (painting){ erasing=false; document.getElementById('erase').setAttribute('aria-pressed','false'); }
    });
    document.getElementById('erase').addEventListener('click', ()=>{
      erasing = !erasing;
      document.getElementById('erase').setAttribute('aria-pressed', erasing?'true':'false');
      if (erasing){ painting=false; document.getElementById('paint').setAttribute('aria-pressed','false'); }
    });

    document.getElementById('random').addEventListener('click', ()=>randomize());
    document.getElementById('clear').addEventListener('click', ()=>clearAll());

    const speed = document.getElementById('speed');
    speed.addEventListener('input', ()=>{
      fps = Number(speed.value);
      fpsLabel.textContent = `${fps} fps`;
      if (running){ clearTimeout(loopId); loop(); }
    });

    canvas.addEventListener('click', (e)=>{
      const r = canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - r.left) / cellSize);
      const y = Math.floor((e.clientY - r.top)  / cellSize);

      // 1) stamp if selected
      if (stampAt(x,y)){ draw(); return; }

      // 2) otherwise, live paint / erase / toggle
      const i = idx(x,y);
      if (erasing) grid[i] = 0;
      else if (painting) grid[i] = 1;
      else grid[i] = grid[i] ? 0 : 1;
      draw();
    });

    // ---------- Service worker (for PWA install/offline) ----------
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js').catch(()=>{}));
    }

    // ---------- Boot ----------
    randomize(0.14);
  </script>
</body>
</html>
