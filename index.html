<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, user-scalable=no"
  />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0d12" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <title>Game of Life ‚Äî iPad</title>
  <style>
    :root{
      --bg:#0b0d12; --fg:#eaecf1; --muted:#9aa3b2;
      --accent:#7c5cff; --accent-2:#2ee6a6;
      --glass:rgba(255,255,255,.06); --glass-strong:rgba(255,255,255,.12);
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
    }
    html,body{
      margin:0;height:100%;background:var(--bg);color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; overscroll-behavior:none;
    }
    #app{position:fixed; inset:0}
    canvas{display:block; width:100%; height:100%; touch-action:none; background:#05070b}

    /* bottom toolbar (equal-width text buttons + stacked sliders) */
    .bar{
      position:fixed; left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px)+12px);
      transform:translateX(-50%);
      display:flex; flex-wrap:wrap; align-items:center; gap:10px;
      background:var(--glass); backdrop-filter:blur(16px) saturate(120%);
      border:1px solid var(--glass-strong); border-radius:var(--radius);
      padding:10px 12px; box-shadow:var(--shadow); z-index:9999;
      max-width:min(980px,92vw);
    }
    .seg{display:flex; flex-wrap:wrap; gap:8px; padding:4px; border-radius:12px;
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12)}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:92px; height:44px; padding:0 12px;
      font-size:13px; font-weight:600; letter-spacing:.2px;
      border-radius:12px; border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.08); color:#fff; white-space:nowrap; flex:0 0 auto;
    }
    @media (max-width:820px){ .btn{ min-width:84px; font-size:12px; } }
    .btn:active{ transform:translateY(1px) }
    .btn.toggle[aria-pressed="true"]{ background:var(--accent); color:#fff }
    .btn.secondary{ background:rgba(255,255,255,.04); color:var(--muted) }

    /* sliders column on right */
    .sliders{
      display:flex; flex-direction:column; gap:8px; align-items:flex-start; justify-content:center;
      padding:6px; border-radius:12px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12);
      flex:0 0 auto;
    }
    .sliders .row{ display:flex; align-items:center; gap:8px }
    .slider{ -webkit-appearance:none; appearance:none; height:8px; border-radius:999px;
      background:rgba(255,255,255,.12); outline:none; width:200px; flex:0 0 auto;}
    @media (max-width:820px){ .slider{ width:160px } }
    .slider::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none; width:22px; height:22px; border-radius:50%;
      background:var(--accent-2); border:2px solid rgba(0,0,0,.25); box-shadow:0 2px 6px rgba(0,0,0,.35);
    }
    .badge{ font-variant-numeric: tabular-nums; color:var(--muted); font-size:12px; }

    /* left stamps toolbar */
    #stamps{
      position:fixed; top:50%; left:12px; transform:translateY(-50%);
      display:flex; flex-direction:column; gap:8px; z-index:9999;
      background:var(--glass); border:1px solid var(--glass-strong);
      border-radius:16px; padding:8px; box-shadow:var(--shadow);
    }
    #stamps .stamp{
      width:42px; height:42px; font-size:18px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:10px; border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.08); color:#fff;
    }
    #stamps .stamp[aria-pressed="true"]{ background:var(--accent); color:#fff }
    @media (max-width:820px){ #stamps{ left:8px } }

    .hint{position:fixed; top:14px; left:50%; transform:translateX(-50%); color:var(--muted); font-size:12px; opacity:.75}

    /* Bestiary modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(2px);
      z-index:10000; display:flex; align-items:flex-end; justify-content:center; }
    .modal[hidden]{ display:none; }
    .sheet{
      width:min(720px,92vw); max-height:80vh; background:var(--glass);
      border:1px solid var(--glass-strong); border-radius:16px 16px 0 0; box-shadow:var(--shadow);
      padding:12px; overflow:auto;
    }
    .sheet-head{
      display:flex; gap:8px; align-items:center; position:sticky; top:0; background:inherit; padding-bottom:8px;
    }
    .sheet-head input{
      flex:1; height:38px; border-radius:10px; border:1px solid rgba(255,255,255,.15);
      background:rgba(0,0,0,.25); color:#fff; padding:0 10px;
    }
    .sheet-body h3{ margin:.6rem 0 .35rem; font-size:14px; color:var(--muted); }
    .sheet-body .grid{ display:flex; flex-wrap:wrap; gap:8px; }
    .sheet-body .grid button{
      height:36px; padding:0 12px; border-radius:10px;
      border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.08);
      color:#fff; font-size:13px;
    }
    .btn.small{ height:36px; padding:0 12px; font-size:13px; }
  </style>
</head>
<body>
  <div id="app">
    <canvas id="life"></canvas>
  </div>

  <!-- left ‚Äústamp‚Äù toolbar (quick access) -->
  <div id="stamps" aria-label="Pattern stamps">
    <button class="stamp" data-pattern="glider"  title="Glider">ü°≤</button>
    <button class="stamp" data-pattern="lwss"    title="LWSS (rocket)">üöÄ</button>
    <button class="stamp" data-pattern="pulsar"  title="Pulsar">‚ú∏</button>
    <button class="stamp" data-pattern="r-pent"  title="R-pentomino">·¥¶</button>
    <button class="stamp" data-pattern="gosper"  title="Gosper gun">üí£</button>
    <button class="stamp" data-pattern="clear"   title="Stamp off">‚èπ</button>
  </div>

  <!-- bottom toolbar -->
  <div class="bar" role="toolbar" aria-label="Controls">
    <div class="seg" aria-label="Playback">
      <button id="run"   class="btn toggle"   aria-pressed="false">Run</button>
      <button id="step"  class="btn secondary">Step</button>
    </div>

    <div class="seg" aria-label="Draw tools">
      <button id="paintToggle" class="btn toggle" aria-pressed="false">Paint</button>
      <button id="eraseToggle" class="btn toggle" aria-pressed="false">Erase</button>
    </div>

    <div class="seg" aria-label="Presets">
      <button id="random" class="btn">Random</button>
      <button id="clear"  class="btn">Clear</button>
      <button id="openBestiary" class="btn">Bestiary</button>
    </div>

    <div class="sliders" aria-label="Sliders">
      <div class="row">
        <input id="speed" class="slider" type="range" min="2" max="60" value="30" />
        <span class="badge" id="fpsLabel">30 fps</span>
      </div>
      <div class="row">
        <input id="cellSize" class="slider" type="range" min="4" max="24" value="10" />
        <span class="badge" id="cellLabel">10 px</span>
      </div>
    </div>
  </div>

  <div class="hint">Tip: two-finger drag to pan, pinch to zoom. Tap to toggle cells. Use Bestiary to arm a named stamp.</div>

  <!-- Bestiary modal -->
  <div id="bestiary" class="modal" hidden>
    <div class="sheet">
      <div class="sheet-head">
        <input id="filter" type="search" placeholder="Search patterns‚Ä¶" />
        <button id="toggleRLE" class="btn small" title="Paste RLE text to import">Import RLE</button>
        <button id="closeBestiary" class="btn small">Close</button>
      </div>
      <div id="rlePane" hidden style="padding:8px 0;">
        <textarea id="rleInput" rows="6" style="width:100%;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.25);color:#fff;padding:8px;" placeholder="Paste RLE pattern text here (from LifeWiki)‚Ä¶"></textarea>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="loadRLE" class="btn small">Arm as Stamp</button>
          <button id="clearRLE" class="btn small">Clear</button>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px;">
          Tip: Open a LifeWiki page (e.g., Demonoid), copy the RLE block, paste it here, then tap ‚ÄúArm as Stamp‚Äù. Pause and zoom out before placing large patterns.
        </div>
      </div>
      <div class="sheet-body" id="bestiaryList">
        <!-- filled by JS -->
      </div>
    </div>
  </div>

  <script>
    // ---------- Canvas & view ----------
    const canvas = document.getElementById('life');
    const ctx = canvas.getContext('2d', { alpha:false });
    const DPR = Math.max(1, window.devicePixelRatio || 1);

    let view = { x:0, y:0, k:1 }; // pan in cells & zoom factor
    function resize(){
      const w = window.innerWidth, h = window.innerHeight;
      canvas.width  = Math.floor(w * DPR);
      canvas.height = Math.floor(h * DPR);
      canvas.style.width = w+'px';
      canvas.style.height = h+'px';
      alloc(); draw();
    }
    window.addEventListener('resize', resize, { passive:true });

    // ---------- Grid (toroidal) ----------
    let cellPx = 10;  // pixels per cell (before zoom & DPR)
    let cols=0, rows=0, size=0;
    let grid = new Uint8Array(0), next = new Uint8Array(0);

    function alloc(){
      cols = Math.max(8, Math.floor((canvas.width / DPR) / (cellPx * view.k)));
      rows = Math.max(8, Math.floor((canvas.height/ DPR) / (cellPx * view.k)));
      size = cols * rows;
      grid = new Uint8Array(size);
      next = new Uint8Array(size);
    }
    function idx(x,y){ return ((y+rows)%rows)*cols + ((x+cols)%cols); }

    function randomize(d=0.18){ for(let i=0;i<size;i++) grid[i] = Math.random()<d?1:0; draw(); }
    function clearAll(){ grid.fill(0); draw(); }

    function step(){
      for(let y=0;y<rows;y++){
        for(let x=0;x<cols;x++){
          const i = y*cols + x;
          let n=0;
          n += grid[idx(x-1,y-1)] + grid[idx(x,y-1)] + grid[idx(x+1,y-1)];
          n += grid[idx(x-1,y  )]                     + grid[idx(x+1,y  )];
          n += grid[idx(x-1,y+1)] + grid[idx(x,y+1)] + grid[idx(x+1,y+1)];
          const g = grid[i];
          next[i] = (g ? (n===2||n===3) : (n===3)) ? 1 : 0;
        }
      }
      const t=grid; grid=next; next=t;
    }

    // ---------- Rendering ----------
    function draw(){
      ctx.fillStyle = '#05070b'; ctx.fillRect(0,0,canvas.width,canvas.height);
      const scale = cellPx * view.k * DPR;
      const ox = Math.floor(view.x * scale), oy = Math.floor(view.y * scale);

      // grid lines (subtle)
      if (scale >= 8){
        ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth=1; ctx.beginPath();
        const W=canvas.width, H=canvas.height;
        for(let x=ox%scale; x<W; x+=scale){ ctx.moveTo(x+.5,0); ctx.lineTo(x+.5,H); }
        for(let y=oy%scale; y<H; y+=scale){ ctx.moveTo(0,y+.5); ctx.lineTo(W,y+.5); }
        ctx.stroke();
      }

      // cells
      ctx.fillStyle = '#cfd6ff';
      const s = Math.max(1, Math.floor(scale)-2);
      for(let y=0;y<rows;y++){
        for(let x=0;x<cols;x++){
          if(!grid[y*cols+x]) continue;
          const px = Math.floor(x*scale + ox);
          const py = Math.floor(y*scale + oy);
          ctx.fillRect(px+1, py+1, s, s);
        }
      }
    }

    // ---------- Controls & state ----------
    let running=false, livePaint=false, eraseMode=false;
    const runBtn = document.getElementById('run');
    const stepBtn = document.getElementById('step');
    const paintBtn = document.getElementById('paintToggle');
    const eraseBtn = document.getElementById('eraseToggle');
    const randomBtn= document.getElementById('random');
    const clearBtn = document.getElementById('clear');
    const speed    = document.getElementById('speed');
    const fpsLabel = document.getElementById('fpsLabel');
    const cellSz   = document.getElementById('cellSize');
    const cellLbl  = document.getElementById('cellLabel');

    function setPressed(el,on){ el.setAttribute('aria-pressed', on?'true':'false'); }

    runBtn.addEventListener('click', ()=>{
      running = !running; setPressed(runBtn, running);
      if (running){ requestFullIfApple(); }
    });
    stepBtn.addEventListener('click', ()=>{ if(!running){ step(); draw(); } });

    paintBtn.addEventListener('click', ()=>{
      livePaint = !livePaint; setPressed(paintBtn, livePaint);
      if (livePaint){ eraseMode=false; setPressed(eraseBtn,false); }
    });
    eraseBtn.addEventListener('click', ()=>{
      eraseMode = !eraseMode; setPressed(eraseBtn, eraseMode);
      if (eraseMode){ livePaint=false; setPressed(paintBtn,false); }
    });

    randomBtn.addEventListener('click', ()=> randomize());
    clearBtn .addEventListener('click', ()=> clearAll());

    let fps = 30;
    speed.addEventListener('input', ()=>{ fps = Number(speed.value); fpsLabel.textContent = `${fps} fps`; });

    cellSz.addEventListener('input', ()=>{
      cellPx = Number(cellSz.value); cellLbl.textContent = `${cellPx} px`;
      alloc(); draw();
    });

    // ---------- Stamps & patterns ----------
    const patterns = {
      // Still lifes
      block: [[0,0],[1,0],[0,1],[1,1]],
      beehive:[[-1,0],[0,-1],[1,-1],[2,0],[1,1],[0,1]],
      boat:[[0,0],[1,0],[0,1],[2,1],[1,2]],
      loaf:[[1,0],[2,0],[0,1],[3,1],[1,2],[2,2],[1,3]],
      // Oscillators
      blinker:[[-1,0],[0,0],[1,0]],
      toad:[[1,0],[2,0],[3,0],[0,1],[1,1],[2,1]],
      beacon:[[0,0],[1,0],[0,1],[3,2],[2,3],[3,3]],
      pulsar:[[-6,-4],[-5,-4],[-4,-4],[-2,-4],[-1,-4],[0,-4],
              [-6, 4],[-5, 4],[-4, 4],[-2, 4],[-1, 4],[ 0, 4],
              [-4,-6],[-4,-5],[-4,-2],[-4,-1],[-4, 0],[-4, 1],
              [ 4,-6],[ 4,-5],[ 4,-2],[ 4,-1],[ 4, 0],[ 4, 1]],
      pentadecathlon:[ // spine + side nubs
        [-4,0],[-3,0],[-2,0],[-1,0],[0,0],[1,0],[2,0],
        [-2,-1],[-2,1],[2,-1],[2,1]
      ],
      // Spaceships
      glider:[[1,0],[2,1],[0,2],[1,2],[2,2]],
      lwss:[[1,0],[2,0],[3,0],[4,0],[0,1],[4,1],[4,2],[0,3],[3,3]],
      mwss:[[1,0],[2,0],[3,0],[4,0],[5,0],[0,1],[5,1],[5,2],[0,3],[4,3],[2,4]],
      hwss:[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0],[0,1],[6,1],[6,2],[0,3],[5,3],[2,4],[3,4]],
      // Methuselahs
      "r-pent":[[0,0],[1,0],[1,1],[1,-1],[2,0]],
      diehard:[[0,0],[1,0],[1,1],[6,1],[7,1],[8,1],[7,-1]],
      acorn:[[0,0],[1,0],[1,2],[3,1],[4,0],[5,0],[6,0]],
      // Guns
      gosper:[
        [5,1],[6,1],[5,2],[6,2],
        [5,11],[6,11],[7,11],
        [4,12],[8,12],
        [3,13],[9,13],
        [3,14],[9,14],
        [6,15],
        [4,16],[8,16],
        [5,17],[6,17],[7,17],
        [6,18],
        [3,21],[4,21],[5,21],
        [3,22],[4,22],[5,22],
        [2,23],[6,23],
        [1,25],[2,25],[6,25],[7,25],
        [3,35],[4,35],[3,36],[4,36]
      ],
      "simkin-gun":[
        [0,0],[1,0],[1,1],[0,1],[-3,7],[-2,7],[2,7],[3,7],[-3,8],[3,8],[-2,9],[2,9],[0,10],[1,10],[2,10]
      ],
    };

    let currentStamp = null; // array of [dx,dy] or null

    function setStampByKey(key){
      const btns=[...document.querySelectorAll('#stamps .stamp')];
      btns.forEach(b=>b.setAttribute('aria-pressed','false'));
      if (!key || key==='clear'){ currentStamp=null; return; }
      currentStamp = patterns[key];
      const b = btns.find(b=>b.dataset.pattern===key); if (b) b.setAttribute('aria-pressed','true');
    }
    document.querySelectorAll('#stamps .stamp').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = btn.dataset.pattern;
        const on = btn.getAttribute('aria-pressed')==='true';
        setStampByKey(on ? 'clear' : key);
      });
    });

    function stampAt(cx,cy){
      if (!currentStamp) return false;
      currentStamp.forEach(([dx,dy])=>{
        const nx=cx+dx, ny=cy+dy;
        if (nx>=0 && nx<cols && ny>=0 && ny<rows) grid[idx(nx,ny)] = 1;
      });
      return true;
    }

    // ---------- Interaction: paint/erase, pan/zoom ----------
    function screenToCell(clientX,clientY){
      const rect = canvas.getBoundingClientRect();
      const sx = (clientX - rect.left) / (cellPx * view.k);
      const sy = (clientY - rect.top ) / (cellPx * view.k);
      return { cx: Math.floor((sx - view.x)), cy: Math.floor((sy - view.y)) };
    }

    let touching=false, lastPaintCell=-1, lastTouches=[];
    function paintAt(clientX,clientY){
      const {cx,cy} = screenToCell(clientX,clientY);
      if (cx<0||cy<0||cx>=cols||cy>=rows) return;
      const i = idx(cx,cy);
      if (i===lastPaintCell) return;
      lastPaintCell=i;
      grid[i] = eraseMode ? 0 : 1; draw();
    }

    canvas.addEventListener('pointerdown', e=>{
      lastPaintCell=-1; touching=true; canvas.setPointerCapture(e.pointerId);
      if (e.isPrimary && e.buttons===1){
        const {cx,cy} = screenToCell(e.clientX,e.clientY);
        // try stamp first
        if (!stampAt(cx,cy)){
          if (livePaint || !running) paintAt(e.clientX,e.clientY);
        }
      }
    });
    canvas.addEventListener('pointermove', e=>{
      if (!touching) return;
      if (e.isPrimary && e.buttons===1 && (livePaint || !running)) paintAt(e.clientX,e.clientY);
    });
    canvas.addEventListener('pointerup', e=>{ touching=false; lastPaintCell=-1; canvas.releasePointerCapture(e.pointerId); });

    // touch pan/zoom
    canvas.addEventListener('touchstart', e=>{
      lastTouches = [...e.touches].map(t=>({id:t.identifier,x:t.clientX,y:t.clientY}));
    }, { passive:true });

    canvas.addEventListener('touchmove', e=>{
      if (e.touches.length===2){
        const [a,b]=e.touches, [la,lb]=lastTouches;
        if (!la||!lb){ lastTouches=[...e.touches].map(t=>({id:t.identifier,x:t.clientX,y:t.clientY})); return; }
        const cx=(a.clientX+b.clientX)*.5, cy=(a.clientY+b.clientY)*.5;
        const lcx=(la.x+lb.x)*.5, lcy=(la.y+lb.y)*.5;
        const d = Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);
        const ld= Math.hypot(la.x-lb.x, la.y-lb.y);
        const k = Math.max(.5, Math.min(6, view.k*(d/ld)));
        const before = screenToCell(cx,cy);
        view.k=k;
        const after = screenToCell(cx,cy);
        view.x += (before.cx-after.cx);
        view.y += (before.cy-after.cy);
        view.x -= (cx-lcx)/(cellPx*view.k);
        view.y -= (cy-lcy)/(cellPx*view.k);
        draw();
      } else if (e.touches.length===1 && (livePaint || !running)){
        const t=e.touches[0]; paintAt(t.clientX,t.clientY);
      }
      lastTouches=[...e.touches].map(t=>({id:t.identifier,x:t.clientX,y:t.clientY}));
    }, { passive:false });

    // ---------- Timing loop ----------
    let fps = 30, acc=0, last=performance.now();
    function frame(ts){
      const dt=(ts-last)/1000; last=ts; acc+=dt;
      const stepTime = 1/fps;
      if (running){
        while(acc>=stepTime){ step(); acc-=stepTime; }
        draw();
      }
      requestAnimationFrame(frame);
    }

    function requestFullIfApple(){
      const el=document.documentElement;
      if (document.fullscreenElement) return;
      const fn = el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen;
      if (fn) { try{ fn.call(el); }catch{} }
    }

    // ---------- Bestiary (with Featured + groups) ----------
    const BESTIARY = {
      "Featured": {
        "Glider": patterns.glider,
        "LWSS": patterns.lwss,
        "R-pentomino": patterns["r-pent"],
        "Acorn": patterns.acorn
      },
      "Still lifes": {
        "Block": patterns.block, "Beehive": patterns.beehive, "Boat": patterns.boat, "Loaf": patterns.loaf
      },
      "Oscillators": {
        "Blinker": patterns.blinker, "Toad": patterns.toad, "Beacon": patterns.beacon,
        "Pulsar": patterns.pulsar, "Pentadecathlon": patterns.pentadecathlon
      },
      "Spaceships": {
        "Glider": patterns.glider, "LWSS": patterns.lwss, "MWSS": patterns.mwss, "HWSS": patterns.hwss
      },
      "Methuselahs": {
        "R-pentomino": patterns["r-pent"], "Diehard": patterns.diehard, "Acorn": patterns.acorn
      },
      "Guns": {
        "Gosper Glider Gun": patterns.gosper, "Simkin Glider Gun": patterns["simkin-gun"]
      }
    };

    const modal = document.getElementById('bestiary');
    const listHost = document.getElementById('bestiaryList');
    const filterBox = document.getElementById('filter');

    function buildBestiary(){
      const q = (filterBox.value||'').toLowerCase();
      listHost.innerHTML = '';
      for (const [group, items] of Object.entries(BESTIARY)){
        const section = document.createElement('section');
        const h = document.createElement('h3'); h.textContent = group; section.appendChild(h);
        const grid = document.createElement('div'); grid.className='grid';
        for (const [name, cells] of Object.entries(items)){
          if(q && !name.toLowerCase().includes(q)) continue;
          const b = document.createElement('button');
          b.textContent = name;
          b.addEventListener('click', ()=>{
            currentStamp = cells; // arm the stamp directly
            document.querySelectorAll('#stamps .stamp').forEach(btn=>btn.setAttribute('aria-pressed','false'));
            modal.hidden = true;
          });
          grid.appendChild(b);
        }
        if (grid.children.length){ section.appendChild(grid); listHost.appendChild(section); }
      }
    }

    document.getElementById('openBestiary').addEventListener('click', ()=>{ modal.hidden=false; buildBestiary(); });
    document.getElementById('closeBestiary').addEventListener('click', ()=>{ modal.hidden=true; });
    modal.addEventListener('click', e=>{ if(e.target===modal) modal.hidden=true; });
    filterBox.addEventListener('input', buildBestiary);

    // ---------- RLE import (Demonoid, etc.) ----------
    const rlePane = document.getElementById('rlePane');
    document.getElementById('toggleRLE').addEventListener('click', ()=>{
      rlePane.hidden = !rlePane.hidden;
    });

    function parseRLE(rle){
      const lines = rle.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      let data = '';
      for (const line of lines){
        if (line.startsWith('#')) continue;
        if (line.startsWith('x') || line.startsWith('x=')) continue;
        data += line;
      }
      const cells = [];
      let x=0, y=0, num='';
      const pushRun = (count, ch) => {
        count = count || 1;
        if (ch === 'o'){ for(let i=0;i<count;i++) cells.push([x+i, y]); }
        x += (ch === 'o' || ch === 'b') ? count : 0;
      };
      for (let i=0;i<data.length;i++){
        const ch = data[i];
        if (/\d/.test(ch)){ num += ch; continue; }
        if (ch === 'o' || ch === 'b'){
          pushRun(num ? parseInt(num,10) : 1, ch); num='';
        } else if (ch === '$'){
          const k = num ? parseInt(num,10) : 1;
          y += k; x = 0; num='';
        } else if (ch === '!'){ break; }
      }
      return cells;
    }

    document.getElementById('loadRLE').addEventListener('click', ()=>{
      const txt = (document.getElementById('rleInput').value||'').trim();
      if (!txt) return;
      const pts = parseRLE(txt);
      if (!pts.length) return;
      // center around bbox center so placement feels natural
      let minx=Infinity,miny=Infinity,maxx=-Infinity,maxy=-Infinity;
      for (const [px,py] of pts){ if(px<minx)minx=px; if(py<miny)miny=py; if(px>maxx)maxx=px; if(py>maxy)maxy=py; }
      const cx = Math.floor((minx+maxx)/2), cy = Math.floor((miny+maxy)/2);
      currentStamp = pts.map(([px,py])=>[px - cx, py - cy]);
      document.querySelectorAll('#stamps .stamp').forEach(b=>b.setAttribute('aria-pressed','false'));
      rlePane.hidden = true;
      // keep modal open for multiple imports; close if you prefer:
      // modal.hidden = true;
    });

    document.getElementById('clearRLE').addEventListener('click', ()=>{
      document.getElementById('rleInput').value = '';
    });

    // ---------- Service worker ----------
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js').catch(()=>{}));
    }

    // ---------- Boot ----------
    function boot(){
      resize();
      document.getElementById('fpsLabel').textContent = `${speed.value} fps`;
      document.getElementById('cellLabel').textContent = `${cellSz.value} px`;
      fps = Number(speed.value);
      cellPx = Number(cellSz.value);
      alloc();
      randomize(0.14);
      requestAnimationFrame(frame);
    }
    boot();
  </script>
</body>
</html>
